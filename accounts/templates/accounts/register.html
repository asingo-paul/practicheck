<!-- templates/accounts/register.html - Updated version -->
{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block title %}Register - PractiCheck{% endblock %}

{% block content %}
<div class="auth-container">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-9 col-md-11">
                <div class="auth-card card shadow-lg border-0">
                    <div class="card-body p-5">
                        <div class="auth-header text-center mb-4">
                            <div class="auth-icon mb-3">
                                <i class="fas fa-user-plus fa-3x text-primary"></i>
                            </div>
                            <h2 class="fw-bold text-gradient">Create Your Account</h2>
                            <p class="text-muted">Join PractiCheck as a Student or Supervisor</p>
                            <small class="text-muted">Lecturer accounts are created by administrators</small>
                        </div>

                        {% if messages %}
                        <div class="messages mb-4">
                            {% for message in messages %}
                            <div class="alert alert-{{ message.tags }} alert-dismissible fade show">
                                <i class="fas {% if message.tags == 'success' %}fa-check-circle{% else %}fa-exclamation-circle{% endif %} me-2"></i>
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            </div>
                            {% endfor %}
                        </div>
                        {% endif %}

                        <form method="post" class="needs-validation" novalidate id="registrationForm">
                            {% csrf_token %}
                            
                            <!-- Basic Information -->
                            <div class="section-card mb-4">
                                <h5 class="section-title"><i class="fas fa-user me-2"></i>Basic Information</h5>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="id_first_name" class="form-label">First Name <span class="text-danger">*</span></label>
                                        <input type="text" name="first_name" class="form-control form-control-lg" id="id_first_name" placeholder="First name" required>
                                        <div class="invalid-feedback">Please provide your first name.</div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="id_last_name" class="form-label">Last Name <span class="text-danger">*</span></label>
                                        <input type="text" name="last_name" class="form-control form-control-lg" id="id_last_name" placeholder="Last name" required>
                                        <div class="invalid-feedback">Please provide your last name.</div>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="id_email" class="form-label">Email Address <span class="text-danger">*</span></label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-envelope"></i></span>
                                        <input type="email" name="email" class="form-control form-control-lg" id="id_email" placeholder="Email address" required>
                                    </div>
                                    <div class="invalid-feedback">Please provide a valid email address.</div>
                                </div>
                            </div>

                            <!-- User Type Selection -->
                            <div class="section-card mb-4">
                                <h5 class="section-title"><i class="fas fa-users me-2"></i>I am a <span class="text-danger">*</span></h5>
                                <div class="row justify-content-center">
                                    <div class="col-md-5 mb-3">
                                        <div class="form-check-card">
                                            <input class="form-check-input" type="radio" name="user_type" id="user_type_student" value="1" checked>
                                            <label class="form-check-label" for="user_type_student">
                                                <div class="card-type">
                                                    <i class="fas fa-user-graduate fa-2x mb-2"></i>
                                                    <h6>Student</h6>
                                                    <small class="text-muted">University student</small>
                                                </div>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-5 mb-3">
                                        <div class="form-check-card">
                                            <input class="form-check-input" type="radio" name="user_type" id="user_type_supervisor" value="2">
                                            <label class="form-check-label" for="user_type_supervisor">
                                                <div class="card-type">
                                                    <i class="fas fa-briefcase fa-2x mb-2"></i>
                                                    <h6>Supervisor</h6>
                                                    <small class="text-muted">Industry professional</small>
                                                </div>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                <!-- Lecturer info note -->
                                <div class="alert alert-info mt-3 mb-0">
                                    <small>
                                        <i class="fas fa-info-circle me-1"></i>
                                        <strong>Lecturer accounts:</strong> Academic staff members should contact the system administrator to create their accounts.
                                    </small>
                                </div>
                            </div>

                            <!-- Student Fields -->
                            <div id="studentFields" class="section-card mb-4">
                                <h5 class="section-title"><i class="fas fa-graduation-cap me-2"></i>Student Information</h5>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Student ID <span class="text-danger">*</span></label>
                                        <div class="input-group">
                                            <span class="input-group-text"><i class="fas fa-id-card"></i></span>
                                            <input type="text" name="student_id" class="form-control" placeholder="Student ID" id="student_id_input" required>
                                        </div>
                                        <div class="form-text" id="student_id_feedback"></div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Year of Study <span class="text-danger">*</span></label>
                                        <div class="input-group">
                                            <span class="input-group-text"><i class="fas fa-calendar-alt"></i></span>
                                            <input type="number" name="year_of_study" class="form-control" min="1" max="6" placeholder="e.g., 3" required>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- University Selection - Simplified to only Machakos University -->
                                <div class="mb-3">
                                    <label class="form-label">University <span class="text-danger">*</span></label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-university"></i></span>
                                        <select id="university" name="university" class="form-select" required>
                                            <option value="mksu" selected>Machakos University</option>
                                        </select>
                                    </div>
                                    <div class="form-text">Currently only Machakos University is supported</div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Department <span class="text-danger">*</span></label>
                                        <div class="input-group">
                                            <span class="input-group-text"><i class="fas fa-building"></i></span>
                                            <select id="department" name="department" class="form-select" required>
                                                <option value="">Select Department</option>
                                                {% for dept in departments %}
                                                <option value="{{ dept.id }}">{{ dept.name }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Course <span class="text-danger">*</span></label>
                                        <div class="input-group">
                                            <span class="input-group-text"><i class="fas fa-book"></i></span>
                                            <select id="course" name="course" class="form-select" required>
                                                <option value="">Select Course</option>
                                                <!-- Courses will be loaded dynamically -->
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Supervisor Fields -->
                            <div id="supervisorFields" class="section-card mb-4" style="display:none;">
                                <h5 class="section-title"><i class="fas fa-briefcase me-2"></i>Supervisor Information</h5>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Organization <span class="text-danger">*</span></label>
                                        <div class="input-group">
                                            <span class="input-group-text"><i class="fas fa-building"></i></span>
                                            <input type="text" name="organization" class="form-control" placeholder="Organization" required>
                                        </div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Position <span class="text-danger">*</span></label>
                                        <div class="input-group">
                                            <span class="input-group-text"><i class="fas fa-user-tie"></i></span>
                                            <input type="text" name="position" class="form-control" placeholder="Position" required>
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Department (Optional)</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-sitemap"></i></span>
                                        <input type="text" name="supervisor_department" class="form-control" placeholder="Department">
                                    </div>
                                </div>
                            </div>

                            <!-- Password Section -->
                            <div class="section-card mb-4">
                                <h5 class="section-title"><i class="fas fa-lock me-2"></i>Security</h5>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Password <span class="text-danger">*</span></label>
                                        <div class="input-group">
                                            <span class="input-group-text"><i class="fas fa-key"></i></span>
                                            <input type="password" name="password1" class="form-control" placeholder="Password" id="password1" required>
                                            <button type="button" class="btn btn-outline-secondary toggle-password">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                        </div>
                                        <div class="form-text">Minimum 8 characters with letters and numbers</div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Confirm Password <span class="text-danger">*</span></label>
                                        <div class="input-group">
                                            <span class="input-group-text"><i class="fas fa-key"></i></span>
                                            <input type="password" name="password2" class="form-control" placeholder="Confirm Password" id="password2" required>
                                            <button type="button" class="btn btn-outline-secondary toggle-password">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Terms Agreement -->
                            <div class="mb-4">
                                <div class="form-check">
                                    <input type="checkbox" class="form-check-input" id="termsAgree" required>
                                    <label class="form-check-label" for="termsAgree">
                                        I agree to the <a href="#" class="text-primary">Terms of Service</a> and <a href="#" class="text-primary">Privacy Policy</a> <span class="text-danger">*</span>
                                    </label>
                                    <div class="invalid-feedback">You must agree to the terms and conditions.</div>
                                </div>
                            </div>

                            <div class="d-grid">
                                <button type="submit" class="btn btn-primary btn-lg py-3">
                                    <i class="fas fa-user-plus me-2"></i>Create Account
                                </button>
                            </div>
                        </form>

                        <div class="text-center mt-4">
                            <p class="mb-0">Already have an account? 
                                <a href="{% url 'accounts:login' %}" class="text-primary fw-semibold">Sign in here</a>
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* Your existing CSS remains the same */
.auth-container { 
    min-height: 100vh; 
    display: flex; 
    align-items: center; 
    background: linear-gradient(135deg, #ecedf1 0%, #f7f5f8 100%);
    padding: 2rem 0;
}

.auth-card { 
    border-radius: 20px; 
    overflow: hidden; 
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
}

.section-card {
    background: #f8f9fa;
    border-radius: 15px;
    padding: 1.5rem;
    border-left: 4px solid #667eea;
}

.section-title {
    color: #495057;
    font-weight: 600;
    margin-bottom: 1rem;
    border-bottom: 1px solid #dee2e6;
    padding-bottom: 0.5rem;
}

.form-check-card {
    border: 2px solid #dee2e6;
    border-radius: 12px;
    padding: 1rem;
    text-align: center;
    transition: all 0.3s ease;
    cursor: pointer;
}

.form-check-card:hover {
    border-color: #667eea;
    transform: translateY(-2px);
}

.form-check-input:checked + .form-check-label .card-type {
    border-color: #667eea;
    background-color: rgba(102, 126, 234, 0.1);
    border-radius: 12px;
}

.card-type {
    padding: 0.5rem;
}

.text-gradient {
    background: linear-gradient(45deg, #667eea, #764ba2);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.input-group-text {
    background-color: #fff;
    border-right: none;
}

.form-control:focus {
    box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
    border-color: #667eea;
}

.btn-primary {
    background: linear-gradient(45deg, #667eea, #764ba2);
    border: none;
    border-radius: 10px;
    font-weight: 600;
    transition: all 0.3s ease;
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
}

.auth-icon {
    animation: bounce 2s infinite;
}

@keyframes bounce {
    0%, 20%, 50%, 80%, 100% {transform: translateY(0);}
    40% {transform: translateY(-10px);}
    60% {transform: translateY(-5px);}
}

/* Responsive styles remain the same */
@media (max-width: 768px) {
    .auth-card {
        margin: 1rem;
        border-radius: 15px;
    }
    .card-body {
        padding: 1.5rem !important;
    }
    .form-label {
        font-size: 0.9rem;
    }
    .btn-lg {
        font-size: 1rem;
        padding: 0.75rem 1rem;
    }
}

@media (max-width: 576px) {
    .auth-container {
        padding: 1rem 0;
    }
    .auth-card {
        margin: 0.5rem;
        border-radius: 12px;
    }
    .card-body {
        padding: 1rem !important;
    }
    .input-group-text {
        font-size: 0.85rem;
        padding: 0.5rem 0.75rem;
    }
    .form-control, 
    .btn {
        font-size: 0.9rem;
    }
    h2.fw-bold {
        font-size: 1.5rem;
    }
    p.text-muted {
        font-size: 0.85rem;
    }
}

/* Loading spinner for dynamic loading */
.loading-spinner {
    display: inline-block;
    width: 1rem;
    height: 1rem;
    border: 2px solid #f3f3f3;
    border-top: 2px solid #667eea;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const studentFields = document.getElementById('studentFields');
    const supervisorFields = document.getElementById('supervisorFields');
    const radios = document.querySelectorAll('input[name="user_type"]');
    const departmentSelect = document.getElementById('department');
    const courseSelect = document.getElementById('course');
    const studentIdInput = document.getElementById('student_id_input');
    const studentIdFeedback = document.getElementById('student_id_feedback');

    function toggleFields() {
        const val = document.querySelector('input[name="user_type"]:checked').value;
        studentFields.style.display = supervisorFields.style.display = 'none';
        studentFields.querySelectorAll('input, select').forEach(i => i.required = false);
        supervisorFields.querySelectorAll('input').forEach(i => i.required = false);

        if(val === '1') { 
            studentFields.style.display='block'; 
            studentFields.querySelectorAll('input, select').forEach(i=>i.required=true);
        }
        else if(val === '2') { 
            supervisorFields.style.display='block'; 
            supervisorFields.querySelectorAll('input').forEach(i=>i.required=true);
        }
    }

    radios.forEach(r => r.addEventListener('change', toggleFields));
    toggleFields(); // Initialize on page load

    // Password toggle
    document.querySelectorAll('.toggle-password').forEach(btn => {
        btn.addEventListener('click', function(){
            const input = this.parentElement.querySelector('input');
            const icon = this.querySelector('i');
            if(input.type === 'password'){ 
                input.type='text'; 
                icon.classList.replace('fa-eye','fa-eye-slash'); 
            }
            else { 
                input.type='password'; 
                icon.classList.replace('fa-eye-slash','fa-eye'); 
            }
        });
    });

    // Student ID availability check
    studentIdInput.addEventListener('blur', function() {
        const studentId = this.value.trim();
        if (studentId.length > 0) {
            studentIdFeedback.innerHTML = '<span class="loading-spinner"></span> Checking availability...';
            studentIdFeedback.className = 'form-text text-info';
            
            fetch(`/accounts/check-student-id/?student_id=${encodeURIComponent(studentId)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.is_taken) {
                        studentIdFeedback.innerHTML = '<i class="fas fa-times-circle text-danger"></i> This Student ID is already registered';
                        studentIdFeedback.className = 'form-text text-danger';
                        studentIdInput.setCustomValidity('Student ID already exists');
                    } else {
                        studentIdFeedback.innerHTML = '<i class="fas fa-check-circle text-success"></i> Student ID is available';
                        studentIdFeedback.className = 'form-text text-success';
                        studentIdInput.setCustomValidity('');
                    }
                })
                .catch(error => {
                    studentIdFeedback.innerHTML = '<i class="fas fa-exclamation-triangle text-warning"></i> Error checking availability';
                    studentIdFeedback.className = 'form-text text-warning';
                });
        } else {
            studentIdFeedback.innerHTML = '';
            studentIdInput.setCustomValidity('');
        }
    });

    // Dynamic Course loading based on Department selection
    departmentSelect.addEventListener('change', function() {
        const departmentId = this.value;
        courseSelect.innerHTML = '<option value="">Select Course</option>';
        
        if (!departmentId) return;

        // Show loading state
        const loadingOption = document.createElement('option');
        loadingOption.value = '';
        loadingOption.textContent = 'Loading courses...';
        loadingOption.disabled = true;
        courseSelect.appendChild(loadingOption);

        // Fetch courses for the selected department
        fetch(`/attachments/api/courses/?department_id=${departmentId}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(courses => {
                courseSelect.innerHTML = '<option value="">Select Course</option>';
                
                if (courses.length === 0) {
                    const noCourseOption = document.createElement('option');
                    noCourseOption.value = '';
                    noCourseOption.textContent = 'No courses available for this department';
                    noCourseOption.disabled = true;
                    courseSelect.appendChild(noCourseOption);
                } else {
                    courses.forEach(course => {
                        const option = document.createElement('option');
                        option.value = course.id;
                        option.textContent = course.name;
                        courseSelect.appendChild(option);
                    });
                }
            })
            .catch(error => {
                console.error('Error loading courses:', error);
                courseSelect.innerHTML = '<option value="">Error loading courses</option>';
                const errorOption = document.createElement('option');
                errorOption.value = '';
                errorOption.textContent = 'Error loading courses. Please try again.';
                errorOption.disabled = true;
                courseSelect.appendChild(errorOption);
            });
    });

    // Form validation
    const form = document.querySelector('.needs-validation');
    form.addEventListener('submit', function(event) {
        // Validate student ID availability
        if (document.querySelector('input[name="user_type"]:checked').value === '1') {
            const studentId = studentIdInput.value.trim();
            if (studentId) {
                // Perform synchronous check on form submission
                fetch(`/accounts/check-student-id/?student_id=${encodeURIComponent(studentId)}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.is_taken) {
                            event.preventDefault();
                            studentIdFeedback.innerHTML = '<i class="fas fa-times-circle text-danger"></i> This Student ID is already registered';
                            studentIdFeedback.className = 'form-text text-danger';
                            studentIdInput.setCustomValidity('Student ID already exists');
                            studentIdInput.reportValidity();
                        } else {
                            studentIdInput.setCustomValidity('');
                            if (!form.checkValidity()) {
                                event.preventDefault();
                                event.stopPropagation();
                            }
                            form.classList.add('was-validated');
                        }
                    })
                    .catch(error => {
                        console.error('Error checking student ID:', error);
                        if (!form.checkValidity()) {
                            event.preventDefault();
                            event.stopPropagation();
                        }
                        form.classList.add('was-validated');
                    });
            } else {
                if (!form.checkValidity()) {
                    event.preventDefault();
                    event.stopPropagation();
                }
                form.classList.add('was-validated');
            }
        } else {
            if (!form.checkValidity()) {
                event.preventDefault();
                event.stopPropagation();
            }
            form.classList.add('was-validated');
        }
    });

    // Real-time validation for student ID format
    studentIdInput.addEventListener('input', function() {
        const studentId = this.value.trim();
        if (studentId.length > 0 && !/^[A-Za-z0-9/-]+$/.test(studentId)) {
            this.setCustomValidity('Student ID can only contain letters, numbers, and hyphens');
        } else {
            this.setCustomValidity('');
        }
    });
});
</script>
{% endblock %}