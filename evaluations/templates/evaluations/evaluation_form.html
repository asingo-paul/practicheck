{% extends "base_student.html" %}
{% load static %}
{% load custom_filters %}


{% block title %}Supervisor Evaluation Form{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row">
        <div class="col-lg-10 mx-auto">
            <!-- Header -->
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-body d-flex justify-content-between align-items-center">
                    <h3 class="card-title mb-0">
                        <i class="bi bi-clipboard-check text-primary me-2"></i>
                        Supervisor Evaluation - {{ attachment.student.username }}
                    </h3>
                    {% if is_edit %}
                        {% if form.instance.status == "submitted" %}
                            <span class="badge bg-success">Submitted</span>
                        {% else %}
                            <span class="badge bg-warning text-dark">Draft</span>
                        {% endif %}
                    {% else %}
                        <span class="badge bg-secondary">New</span>
                    {% endif %}
                </div>
            </div>

            <!-- Evaluation Form -->
            <form method="post" class="card shadow-sm border-0">
                {% csrf_token %}
                <div class="card-body">
                    <!-- Criteria Section -->
                    <h5 class="mb-3">Evaluation Criteria</h5>
                    <div class="list-group mb-4">
                        {% for criteria in criteria_list %}
                        <div class="list-group-item">
                            <div class="d-flex justify-content-between align-items-center">
                                <label class="fw-bold">{{ criteria.name }}</label>
                                <span class="text-muted small">{{ criteria.description }}</span>
                            </div>
                            <input type="range" 
                                   class="form-range mt-2" 
                                   min="1" max="10" step="1" 
                                   id="criteria_{{ criteria.id }}" 
                                   name="criteria_{{ criteria.id }}" 
                                   value="{{ form.initial|get_item:criteria.id|default:5 }}"
                                   oninput="calculateOverallScore()">
                        </div>
                        {% endfor %}
                    </div>

                    <!-- Overall Rating -->
                    <h5 class="mb-3">Overall Rating</h5>
                    <div class="progress mb-2" style="height: 25px;">
                        <div id="overallProgress" 
                             class="progress-bar progress-bar-striped bg-primary" 
                             role="progressbar" style="width: 0%;">
                        </div>
                    </div>
                    <p><strong>Overall Score:</strong> <span id="overallScore">0%</span></p>
                    <p><strong>Average Rating:</strong> <span id="averageScore">0</span>/10</p>

                    <!-- Hidden overall_rating (bound to form) -->
                    {{ form.overall_rating }}

                    <!-- Comments -->
                    <div class="mb-3">
                        <label for="{{ form.comments.id_for_label }}" class="form-label">Supervisor Comments</label>
                        {{ form.comments }}
                        {% if form.comments.errors %}
                            <div class="text-danger small">{{ form.comments.errors }}</div>
                        {% endif %}
                    </div>

                    <!-- Recommendation -->
                    <div class="mb-3">
                        <label class="form-label">Recommendation</label>
                        {{ form.recommendation }}
                        {% if form.recommendation.errors %}
                            <div class="text-danger small">{{ form.recommendation.errors }}</div>
                        {% endif %}
                    </div>

                    <!-- Hidden status field -->
                    {{ form.status }}
                </div>

                <!-- Footer Actions -->
                <div class="card-footer d-flex justify-content-between">
                    <a href="{% url 'evaluations:supervisor_dashboard' %}" class="btn btn-secondary">
                        <i class="bi bi-arrow-left"></i> Back
                    </a>
                    <div>
                        <button type="submit" name="save_draft" class="btn btn-outline-primary">
                            <i class="bi bi-save"></i> Save Draft
                        </button>
                        <button type="submit" name="submit" class="btn btn-success">
                            <i class="bi bi-check2-circle"></i> Submit Evaluation
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Script for dynamic score calculation -->
<script>
function calculateOverallScore() {
    let totalScore = 0;
    let criteriaCount = 0;

    {% for criteria in criteria_list %}
    const val{{ criteria.id }} = parseInt(document.getElementById('criteria_{{ criteria.id }}').value) || 0;
    totalScore += val{{ criteria.id }};
    criteriaCount++;
    {% endfor %}

    if (criteriaCount > 0) {
        const averageScore = totalScore / criteriaCount;
        const overallScore = (averageScore / 10) * 100;

        document.getElementById('overallScore').textContent = `${overallScore.toFixed(0)}%`;
        document.getElementById('averageScore').textContent = averageScore.toFixed(1);

        // Update progress bar
        document.getElementById('overallProgress').style.width = `${overallScore.toFixed(0)}%`;

        // Push to hidden input (form field id from Django)
        const overallField = document.getElementById("id_overall_rating");
        if (overallField) {
            overallField.value = Math.round(averageScore);
        }
    }
}

// Initialize calculation on load
document.addEventListener("DOMContentLoaded", calculateOverallScore);
</script>
{% endblock %}
